<!DOCTYPE HTML>
<html>

    <head>
        <meta http-equiv="Content-Type" content = "text/html ; charset = utf-8" />
        <link rel="stylesheet" type="text/css" href="guacamole.css"/>
        <title>Guacamole (EXAMPLE)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />
    </head>
    <body>
    <input type="file" name="setfilex" />

    <!-- Display -->
        <div id="display" style="height: auto;width: auto;"></div>
        <!-- Guacamole JavaScript API -->
        <script type="text/javascript" src="js/guacamole/all.min.js"></script>
        <script src="js/jquery-2.1.3.min.js"></script>
        <script src="js/fileSaver.js"></script>
        <!-- Init -->
        <script type="text/javascript"> /* <![CDATA[ */

            // Get display div from document
            var display = document.getElementById("display");
            // Instantiate client, using an HTTP tunnel for communications.
            var guac = new Guacamole.Client(
                new Guacamole.HTTPTunnel("tunnel")
            );

            // Add client to display div
            display.appendChild(guac.getDisplay().getElement());


            
            // Error handler
            guac.onerror = function(error) {
                alert(error.message);
                console.log(error)
            };

            // Connect
            guac.connect();

            // Disconnect on close
            window.onunload = function() {
                guac.disconnect();
            }

            // Mouse
            var mouse = new Guacamole.Mouse(guac.getDisplay().getElement());

            mouse.onmousedown = 
            mouse.onmouseup   =
            mouse.onmousemove = function(mouseState) {
                guac.sendMouseState(mouseState);
            };

            // Keyboard
            var keyboard = new Guacamole.Keyboard(document);

            keyboard.onkeydown = function (keysym) {
                guac.sendKeyEvent(1, keysym);
            };

            keyboard.onkeyup = function (keysym) {
                guac.sendKeyEvent(0, keysym);
            };

        //监听堡垒机端往剪切板复制事件，然后写入文本框中
        guac.onclipboard = function(stream, mimetype){
            if (/^text\//.exec(mimetype)) {
                var stringReader = new Guacamole.StringReader(stream);
                stringReader.ontext = function ontext(text) {
                    stringReader.onend = function() {
                        navigator.clipboard.writeText(text);
                    }
                }

            }

        }

        //将内容传送到往堡垒机，data是获取到的文本框中的内容
        function setClipboard(data) {
            var stream = guac.createClipboardStream("text/plain");
            var writer = new Guacamole.StringWriter(stream);
            for (var i=0; i<data.length; i += 4096){
                writer.sendText(data.substring(i, i+4096));
            }

            writer.sendEnd();
        }

        ref = setInterval(function(){
            navigator.clipboard.readText()
                .then(text => {
                    setClipboard(text);
                })
                .catch(err => {
            });
        },1000);


        //下载
        guac.onfile = function(stream, mimetype, filename){
            //通知服务端，已经收到了stream
            stream.sendAck('OK', Guacamole.Status.Code.SUCCESS);
            //开始处理输入流，这里封装了一个downloadFile方法
            downloadFile(stream, mimetype, filename);
        }
        //处理输入流的逻辑
        downloadFile = (stream, mimetype, filename) => {
            //拿到的流不能直接使用，先实例化一个处理器，使用blob reader处理数据
            var blob_builder;
            if      (window.BlobBuilder)       blob_builder = new BlobBuilder();
            else if (window.WebKitBlobBuilder) blob_builder = new WebKitBlobBuilder();
            else if (window.MozBlobBuilder)    blob_builder = new MozBlobBuilder();
            else
                blob_builder = new (function() {

                    var blobs = [];

                    /** @ignore */
                    this.append = function(data) {
                        blobs.push(new Blob([data], {"type": mimetype}));
                    };

                    /** @ignore */
                    this.getBlob = function() {
                        return new Blob(blobs, {"type": mimetype});
                    };

                })();

            // Append received blobs
            stream.onblob = function(data) {

                // Convert to ArrayBuffer
                var binary = window.atob(data);
                var arrayBuffer = new ArrayBuffer(binary.length);
                var bufferView = new Uint8Array(arrayBuffer);

                for (var i=0; i<binary.length; i++)
                    bufferView[i] = binary.charCodeAt(i);

                //收到后就交给blob_builder
                blob_builder.append(arrayBuffer);
                length += arrayBuffer.byteLength;

                // Send success response
                stream.sendAck("OK", 0x0000);

            };

            stream.onend = function(){
                //结束的时候，获取blob_builder里面的可用数据
                var blob_data = blob_builder.getBlob();

                //数据传输完成后进行下载等处理
                if(mimetype.indexOf('stream-index+json') != -1){
                    //如果是文件夹,使用filereader读取blob数据，可以获得该文件夹下的文件和目录的名称和类型，是一个json形式
                    var blob_reader = new FileReader();
                    blob_reader.addEventListener("loadend", function() {
                        let folder_content = JSON.parse(blob_reader.result)
                        //重新组织当前文件目录，appendFileItem是自己封装的文件系统动态展示
                        appendFileItem(folder_content)
                        $("#header_title").text(filename);
                    });
                    blob_reader.readAsBinaryString(blob_data);
                } else {
                    //如果是文件，直接下载，但是需要解决个问题，就是如何下载blob数据
                    //借鉴了https://github.com/eligrey/FileSaver.js这个库
                    var file_arr = filename.split("/");
                    var download_file_name = file_arr[file_arr.length - 1];
                    saveAs(blob_data, download_file_name);
                }
            }
        }

        //上传文件拖拽
        var ffobjx=document.getElementsByName("setfilex")[0];//得到文件表单对象    （input）
        var divobjx=document.getElementById("display");//得到文件拖拽框对象
        //屏蔽系统默认事件
        divobjx.ondragover=function(e){
            e.preventDefault();
        }
        //监听拖拽事件
        divobjx.ondrop=function(e){
            e.preventDefault();
            ffobjx.files=e.dataTransfer.files;//将拖拽信息设置到表单上
            var f =ffobjx.files[0];
            alert("文件名"+f.name+"  大小："+Math.round(f.size/1024)+"KB");
        }




        //$('canvas').css("width","1380px")
</script>

    </body>
<style>
    canvas{
        cursor: none!important;
        height: auto;
        width: auto;
    }
    div{
        height: auto;
        width: auto;
    }
</style>


</html>
